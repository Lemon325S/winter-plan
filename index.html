<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜ä¸€å¯’å‡æ¯æ—¥è®¡åˆ’æ‰“å¡</title>
    <!-- æ›¿æ¢CDNåœ°å€ï¼Œé¿å…è·Ÿè¸ªé˜²æŠ¤æ‹¦æˆª -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        :root {
            --primary-color: #4361ee;
            --primary-light: #7209b7;
            --success-color: #38b000;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
            min-height: 100vh;
            padding: 1rem;
            color: var(--text-primary);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
        }

        h1 {
            text-align: center;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .func-toggle {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .func-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--bg-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .func-btn.active {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .day-selector {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .day-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--radius-sm);
            background-color: var(--bg-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-btn.active {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            color: white;
            transform: translateY(-2px);
        }

        .task-form {
            background: var(--bg-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .task-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-secondary {
            background: var(--bg-color);
            color: var(--text-primary);
        }

        .task-section {
            margin-bottom: 1.5rem;
            background: var(--bg-color);
            border-radius: var(--radius-md);
            padding: 1rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e8f0fe;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.8rem;
            background-color: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid var(--border-color);
            gap: 1rem;
        }

        .task-item.completed {
            background-color: #f0fdf4;
            border-color: #bbf7d0;
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .task-time {
            min-width: 5rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        .task-content {
            flex: 1;
            line-height: 1.4;
        }

        .task-check {
            width: 1.8rem;
            height: 1.8rem;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .task-item.completed .task-check {
            background: linear-gradient(90deg, var(--success-color), #16a34a);
            border-color: var(--success-color);
            color: white;
            content: 'âœ“';
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            display: none;
        }

        .loading.active {
            display: block;
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .celebration-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            text-align: center;
            animation: pop 0.5s ease;
            max-width: 90%;
            width: 400px;
        }

        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .celebration h2 {
            background: linear-gradient(90deg, var(--success-color), #16a34a);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .task-item {
                padding: 0.8rem;
                gap: 0.5rem;
            }
            .task-time {
                min-width: 4rem;
            }
            .task-check {
                width: 1.5rem;
                height: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é«˜ä¸€å¯’å‡æ¯æ—¥è®¡åˆ’æ‰“å¡</h1>
        
        <div class="func-toggle">
            <button class="func-btn active" id="btn-check">æ‰“å¡æ¨¡å¼</button>
            <button class="func-btn" id="btn-manage">ç®¡ç†ä»»åŠ¡</button>
        </div>

        <div class="day-selector">
            <button class="day-btn active" data-day="å‘¨ä¸€">å‘¨ä¸€</button>
            <button class="day-btn" data-day="å‘¨äºŒ">å‘¨äºŒ</button>
            <button class="day-btn" data-day="å‘¨ä¸‰">å‘¨ä¸‰</button>
            <button class="day-btn" data-day="å‘¨å››">å‘¨å››</button>
            <button class="day-btn" data-day="å‘¨äº”">å‘¨äº”</button>
            <button class="day-btn" data-day="å‘¨å…­">å‘¨å…­</button>
            <button class="day-btn" data-day="å‘¨æ—¥">å‘¨æ—¥</button>
        </div>

        <div class="task-form" id="taskForm">
            <div class="form-group">
                <label for="taskDay">æ˜ŸæœŸ</label>
                <select id="taskDay">
                    <option value="å‘¨ä¸€">å‘¨ä¸€</option>
                    <option value="å‘¨äºŒ">å‘¨äºŒ</option>
                    <option value="å‘¨ä¸‰">å‘¨ä¸‰</option>
                    <option value="å‘¨å››">å‘¨å››</option>
                    <option value="å‘¨äº”">å‘¨äº”</option>
                    <option value="å‘¨å…­">å‘¨å…­</option>
                    <option value="å‘¨æ—¥">å‘¨æ—¥</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskTime">æ—¶é—´æ®µ</label>
                <input type="text" id="taskTime" placeholder="ä¾‹å¦‚ï¼š08:30-09:00">
            </div>
            <div class="form-group">
                <label for="taskContent">ä»»åŠ¡å†…å®¹</label>
                <textarea id="taskContent" rows="2" placeholder="è¾“å…¥ä»»åŠ¡å†…å®¹"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="btn-clear">æ¸…ç©º</button>
                <button class="btn btn-primary" id="btn-save">ä¿å­˜ä»»åŠ¡</button>
            </div>
        </div>

        <div class="loading active" id="loading">åŠ è½½ä¸­...</div>
        <div id="task-container"></div>
    </div>

    <div class="celebration" id="celebration">
        <div class="celebration-content">
            <h2>ğŸ‰ å¤ªæ£’äº†ï¼ä»Šå¤©çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆå•¦ï¼</h2>
            <p>ç»§ç»­ä¿æŒï¼Œä½ è¶…æ£’çš„ï¼</p>
            <button class="btn btn-primary" onclick="closeCelebration()">å…³é—­</button>
        </div>
    </div>

    <script>
        // ========== æ›¿æ¢æˆä½ è‡ªå·±çš„Supabaseä¿¡æ¯ï¼ˆå¿…é¡»æ”¹ï¼ï¼‰ ==========
        const SUPABASE_URL = "https://ydvzwsfowkyquqoigrmg.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_vJdssfr65laQD2c8PvTSRw_bxbsC3re";

        // å…¨å±€Supabaseå®¢æˆ·ç«¯ï¼ˆæ— é‡å¤å£°æ˜ï¼‰
        let supabase;
        try {
            // åˆå§‹åŒ–Supabaseï¼Œç¦ç”¨ä¸å¿…è¦çš„å­˜å‚¨è·Ÿè¸ª
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    storage: false, // å…³é—­æœ¬åœ°å­˜å‚¨ï¼Œé¿å…è·Ÿè¸ªé˜²æŠ¤æ‹¦æˆª
                    autoRefreshToken: false,
                    persistSession: false
                }
            });
        } catch (err) {
            alert("Supabaseåˆå§‹åŒ–å¤±è´¥ï¼š" + err.message);
        }

        let currentDay = "å‘¨ä¸€";
        let currentMode = "check";

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            bindAllEvents();
            loadTasks(currentDay);
        });

        // ç»‘å®šæ‰€æœ‰äº¤äº’äº‹ä»¶
        function bindAllEvents() {
            // åŠŸèƒ½åˆ‡æ¢æŒ‰é’®
            document.getElementById('btn-check').addEventListener('click', function() {
                currentMode = "check";
                setActiveClass('func-btn', 'btn-check');
                document.getElementById('taskForm').classList.remove('active');
                loadTasks(currentDay);
            });

            document.getElementById('btn-manage').addEventListener('click', function() {
                currentMode = "manage";
                setActiveClass('func-btn', 'btn-manage');
                document.getElementById('taskForm').classList.add('active');
                loadTasks(currentDay);
            });

            // æ—¥æœŸé€‰æ‹©æŒ‰é’®
            document.querySelectorAll('.day-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    currentDay = this.dataset.day;
                    setActiveClass('day-btn', this.dataset.day);
                    loadTasks(currentDay);
                });
            });

            // è¡¨å•æŒ‰é’®
            document.getElementById('btn-save').addEventListener('click', saveNewTask);
            document.getElementById('btn-clear').addEventListener('click', clearTaskForm);
        }

        // è®¾ç½®æ¿€æ´»çŠ¶æ€
        function setActiveClass(btnClass, activeId) {
            document.querySelectorAll('.' + btnClass).forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.id === activeId || btn.dataset.day === activeId) {
                    btn.classList.add('active');
                }
            });
        }

        // åŠ è½½æŒ‡å®šæ—¥æœŸçš„ä»»åŠ¡
        async function loadTasks(day) {
            const container = document.getElementById('task-container');
            const loading = document.getElementById('loading');
            loading.classList.add('active');
            container.innerHTML = '';

            try {
                // æŸ¥è¯¢ä»»åŠ¡æ•°æ®
                const { data: tasks, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('day', day)
                    .order('time');

                if (error) throw error;

                if (!tasks || tasks.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-secondary);">æš‚æ— ä»»åŠ¡ï¼Œå¯åœ¨ç®¡ç†æ¨¡å¼æ·»åŠ </div>';
                    loading.classList.remove('active');
                    return;
                }

                // æŒ‰æ—¶é—´æ®µåˆ†ç»„
                const sections = {
                    'ä¸Šåˆ': [],
                    'ä¸­åˆ': [],
                    'ä¸‹åˆ': [],
                    'æ™šä¸Š': []
                };

                tasks.forEach(function(task) {
                    const hour = task.time ? parseInt(task.time.split('-')[0].split(':')[0]) : 0;
                    if (hour >= 9 && hour < 12) sections.ä¸Šåˆ.push(task);
                    else if (hour >= 12 && hour < 14) sections.ä¸­åˆ.push(task);
                    else if (hour >= 14 && hour < 18) sections.ä¸‹åˆ.push(task);
                    else sections.æ™šä¸Š.push(task);
                });

                // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                let htmlContent = '';
                for (const [sectionName, taskList] of Object.entries(sections)) {
                    if (taskList.length === 0) continue;
                    
                    htmlContent += `<div class="task-section">
                        <div class="section-title">${sectionName}</div>
                        <ul class="task-list">`;
                    
                    for (const task of taskList) {
                        // æŸ¥è¯¢æ‰“å¡çŠ¶æ€
                        const { data: checkin } = await supabase
                            .from('checkins')
                            .select('is_completed')
                            .eq('task_id', task.id)
                            .eq('user_id', 'default_user')
                            .single();
                        
                        const isCompleted = checkin ? checkin.is_completed : false;
                        const deleteBtn = currentMode === 'manage' 
                            ? `<span style="color:#ef4444; cursor:pointer; margin-left:8px;" onclick="deleteTask('${task.id}')">ğŸ—‘ï¸</span>` 
                            : '';

                        htmlContent += `<li class="task-item ${isCompleted ? 'completed' : ''}" onclick="toggleCheck('${task.id}', this)">
                            <span class="task-time">${task.time}</span>
                            <span class="task-content">${task.content}${deleteBtn}</span>
                            <span class="task-check">${isCompleted ? 'âœ“' : ''}</span>
                        </li>`;
                    }
                    
                    htmlContent += `</ul></div>`;
                }

                container.innerHTML = htmlContent;
                checkAllTasksCompleted(day);
            } catch (err) {
                container.innerHTML = `<div style="text-align:center; padding:2rem; color:#ef4444;">åŠ è½½å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
            } finally {
                loading.classList.remove('active');
            }
        }

        // åˆ‡æ¢æ‰“å¡çŠ¶æ€
        async function toggleCheck(taskId, el) {
            try {
                // æŸ¥è¯¢å½“å‰æ‰“å¡çŠ¶æ€
                const { data: checkin, error } = await supabase
                    .from('checkins')
                    .select('id, is_completed')
                    .eq('task_id', taskId)
                    .eq('user_id', 'default_user')
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116æ˜¯æ— æ•°æ®çš„æ­£å¸¸é”™è¯¯

                const newState = checkin ? !checkin.is_completed : true;

                if (checkin) {
                    // æ›´æ–°ç°æœ‰æ‰“å¡è®°å½•
                    await supabase
                        .from('checkins')
                        .update({ is_completed: newState })
                        .eq('id', checkin.id);
                } else {
                    // åˆ›å»ºæ–°æ‰“å¡è®°å½•
                    await supabase
                        .from('checkins')
                        .insert({
                            task_id: taskId,
                            user_id: 'default_user',
                            is_completed: newState
                        });
                }

                // æ›´æ–°UI
                el.classList.toggle('completed', newState);
                el.querySelector('.task-check').textContent = newState ? 'âœ“' : '';
                
                // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                checkAllTasksCompleted(currentDay);
            } catch (err) {
                alert('æ‰“å¡å¤±è´¥ï¼š' + err.message);
            }
        }

        // ä¿å­˜æ–°ä»»åŠ¡
        async function saveNewTask() {
            const day = document.getElementById('taskDay').value;
            const time = document.getElementById('taskTime').value.trim();
            const content = document.getElementById('taskContent').value.trim();

            if (!time || !content) {
                alert('è¯·å¡«å†™æ—¶é—´æ®µå’Œä»»åŠ¡å†…å®¹ï¼');
                return;
            }

            try {
                const { error } = await supabase
                    .from('tasks')
                    .insert({ day, time, content });

                if (error) throw error;

                alert('ä»»åŠ¡ä¿å­˜æˆåŠŸï¼');
                clearTaskForm();
                loadTasks(currentDay);
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                // å…ˆåˆ é™¤å…³è”çš„æ‰“å¡è®°å½•
                await supabase.from('checkins').delete().eq('task_id', taskId);
                // å†åˆ é™¤ä»»åŠ¡
                const { error } = await supabase.from('tasks').delete().eq('id', taskId);

                if (error) throw error;

                loadTasks(currentDay);
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
            }
        }

        // æ¸…ç©ºè¡¨å•
        function clearTaskForm() {
            document.getElementById('taskTime').value = '';
            document.getElementById('taskContent').value = '';
        }

        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨ä»»åŠ¡å®Œæˆ
        async function checkAllTasksCompleted(day) {
            const { data: tasks } = await supabase.from('tasks').select('id').eq('day', day);
            if (!tasks || tasks.length === 0) return;

            let completedCount = 0;
            for (const task of tasks) {
                const { data: checkin } = await supabase
                    .from('checkins')
                    .select('is_completed')
                    .eq('task_id', task.id)
                    .eq('user_id', 'default_user')
                    .single();
                
                if (checkin && checkin.is_completed) completedCount++;
            }

            if (completedCount === tasks.length) {
                document.getElementById('celebration').style.display = 'flex';
            }
        }

        // å…³é—­åº†ç¥å¼¹çª—
        function closeCelebration() {
            document.getElementById('celebration').style.display = 'none';
        }
    </script>
</body>
</html>
