<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ä¸€å¯’å‡æ¯æ—¥è®¡åˆ’æ‰“å¡</title>
    <link rel="icon" href="data:,">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'å¾®è½¯é›…é»‘', PingFang SC, sans-serif; }
        body { background: #f5f7fa; padding: 1rem; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #4361ee; margin-bottom: 1.5rem; font-size: 1.8rem; }
        
        /* åŠŸèƒ½æŒ‰é’® */
        .func-toggle { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
        .func-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; background: #f0f2f5; cursor: pointer; }
        .func-btn.active { background: #4361ee; color: white; }
        
        /* æ—¥æœŸé€‰æ‹© */
        .day-selector { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .day-btn { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; background: #f0f2f5; color: #666; cursor: pointer; }
        .day-btn.active { background: #4361ee; color: white; }
        
        /* ä»»åŠ¡è¡¨å• */
        .task-form { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .task-form.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .form-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; }
        .btn-primary { background: #4361ee; color: white; }
        .btn-secondary { background: #f0f2f5; color: #333; }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-section { margin-bottom: 1rem; background: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .section-title { color: #4361ee; font-weight: 600; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e8f0fe; }
        .task-item { display: flex; align-items: center; padding: 0.8rem; background: white; border-radius: 8px; margin-bottom: 0.8rem; border: 1px solid #eee; cursor: pointer; gap: 1rem; }
        .task-item.completed { background: #f0fdf4; text-decoration: line-through; color: #666; }
        .task-time { min-width: 5rem; color: #4361ee; }
        .task-content { flex: 1; }
        .task-check { width: 1.8rem; height: 1.8rem; border: 2px solid #4361ee; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .task-item.completed .task-check { background: #38b000; border-color: #38b000; color: white; content: 'âœ“'; }
        
        /* åŠ è½½å’Œå¼¹çª— */
        .loading { text-align: center; padding: 2rem; color: #666; display: none; }
        .loading.active { display: block; }
        .celebration { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 999; }
        .celebration-content { background: white; padding: 2rem; border-radius: 12px; text-align: center; }
        .celebration h2 { color: #38b000; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>é«˜ä¸€å¯’å‡æ¯æ—¥è®¡åˆ’æ‰“å¡</h1>
        
        <div class="func-toggle">
            <button class="func-btn active" id="btn-check">æ‰“å¡æ¨¡å¼</button>
            <button class="func-btn" id="btn-manage">ç®¡ç†ä»»åŠ¡</button>
        </div>

        <div class="day-selector">
            <button class="day-btn active" data-day="å‘¨ä¸€">å‘¨ä¸€</button>
            <button class="day-btn" data-day="å‘¨äºŒ">å‘¨äºŒ</button>
            <button class="day-btn" data-day="å‘¨ä¸‰">å‘¨ä¸‰</button>
            <button class="day-btn" data-day="å‘¨å››">å‘¨å››</button>
            <button class="day-btn" data-day="å‘¨äº”">å‘¨äº”</button>
            <button class="day-btn" data-day="å‘¨å…­">å‘¨å…­</button>
            <button class="day-btn" data-day="å‘¨æ—¥">å‘¨æ—¥</button>
        </div>

        <div class="task-form" id="taskForm">
            <div class="form-group">
                <label>æ˜ŸæœŸ</label>
                <select id="taskDay">
                    <option value="å‘¨ä¸€">å‘¨ä¸€</option><option value="å‘¨äºŒ">å‘¨äºŒ</option><option value="å‘¨ä¸‰">å‘¨ä¸‰</option>
                    <option value="å‘¨å››">å‘¨å››</option><option value="å‘¨äº”">å‘¨äº”</option><option value="å‘¨å…­">å‘¨å…­</option><option value="å‘¨æ—¥">å‘¨æ—¥</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ—¶é—´æ®µ</label>
                <input type="text" id="taskTime" placeholder="ä¾‹å¦‚ï¼š08:30-09:00">
            </div>
            <div class="form-group">
                <label>ä»»åŠ¡å†…å®¹</label>
                <textarea id="taskContent" rows="2" placeholder="è¾“å…¥ä»»åŠ¡å†…å®¹"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="btn-clear">æ¸…ç©º</button>
                <button class="btn btn-primary" id="btn-save">ä¿å­˜ä»»åŠ¡</button>
            </div>
        </div>

        <div class="loading active" id="loading">åŠ è½½ä¸­...</div>
        <div id="task-container"></div>
    </div>

    <div class="celebration" id="celebration">
        <div class="celebration-content">
            <h2>ğŸ‰ å¤ªæ£’äº†ï¼ä»Šå¤©çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆå•¦ï¼</h2>
            <p>ç»§ç»­ä¿æŒï¼Œä½ è¶…æ£’çš„ï¼</p>
            <button class="btn btn-primary" onclick="closeCelebration()">å…³é—­</button>
        </div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½®ï¼ˆæ›¿æ¢æˆä½ çš„Supabaseä¿¡æ¯ï¼‰ ==========
        const CONFIG = {
            url: "https://ydvzwsfowkyquqoigrmg.supabase.co", // ä¾‹ï¼šhttps://abc123.supabase.co
            key: "sb_publishable_vJdssfr65laQD2c8PvTSRw_bxbsC3re" // ä¾‹ï¼šeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        };

        // ========== ä¿®å¤ç‰ˆç®€æ˜“Supabaseå®¢æˆ·ç«¯ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰ ==========
        class SimpleSupabase {
            constructor(url, key) {
                this.baseUrl = `${url}/rest/v1`;
                this.headers = {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                };
                // å­˜å‚¨é“¾å¼è°ƒç”¨çš„å‚æ•°
                this.queryParams = {
                    table: '',
                    filters: [],
                    fields: '*'
                };
            }

            // é€‰æ‹©è¡¨
            from(table) {
                this.queryParams.table = table;
                this.queryParams.filters = []; // é‡ç½®è¿‡æ»¤å™¨
                return this; // è¿”å›è‡ªèº«ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
            }

            // é€‰æ‹©å­—æ®µ
            select(fields = '*') {
                this.queryParams.fields = fields;
                return this;
            }

            // ç­‰äºè¿‡æ»¤å™¨
            eq(column, value) {
                this.queryParams.filters.push(`${column}=eq.${encodeURIComponent(value)}`);
                return this;
            }

            // æ’åº
            order(column) {
                this.queryParams.filters.push(`order=${column}.asc`);
                return this;
            }

            // æ‰§è¡ŒæŸ¥è¯¢ï¼ˆæœ€ç»ˆè°ƒç”¨ï¼‰
            async execute() {
                const { table, fields, filters } = this.queryParams;
                if (!table) throw new Error('è¯·å…ˆè°ƒç”¨from()æŒ‡å®šè¡¨å');
                
                // æ‹¼æ¥æŸ¥è¯¢å‚æ•°
                let queryString = `select=${fields}`;
                if (filters.length > 0) {
                    queryString += `&${filters.join('&')}`;
                }

                const response = await fetch(`${this.baseUrl}/${table}?${queryString}`, {
                    method: 'GET',
                    headers: this.headers
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æŸ¥è¯¢å¤±è´¥ï¼š${errorText}`);
                }

                return { data: await response.json(), error: null };
            }

            // æ’å…¥æ•°æ®
            async insert(data) {
                const { table } = this.queryParams;
                if (!table) throw new Error('è¯·å…ˆè°ƒç”¨from()æŒ‡å®šè¡¨å');

                const response = await fetch(`${this.baseUrl}/${table}`, {
                    method: 'POST',
                    headers: this.headers,
                    body: JSON.stringify(Array.isArray(data) ? data : [data])
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æ’å…¥å¤±è´¥ï¼š${errorText}`);
                }

                return { data: await response.json(), error: null };
            }

            // æ›´æ–°æ•°æ®
            async update(data) {
                const { table, filters } = this.queryParams;
                if (!table) throw new Error('è¯·å…ˆè°ƒç”¨from()æŒ‡å®šè¡¨å');
                if (filters.length === 0) throw new Error('æ›´æ–°éœ€è¦å…ˆè°ƒç”¨eq()æŒ‡å®šæ¡ä»¶');

                const queryString = filters.join('&');
                const response = await fetch(`${this.baseUrl}/${table}?${queryString}`, {
                    method: 'PATCH',
                    headers: this.headers,
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æ›´æ–°å¤±è´¥ï¼š${errorText}`);
                }

                return { data: await response.json(), error: null };
            }

            // åˆ é™¤æ•°æ®
            async delete() {
                const { table, filters } = this.queryParams;
                if (!table) throw new Error('è¯·å…ˆè°ƒç”¨from()æŒ‡å®šè¡¨å');
                if (filters.length === 0) throw new Error('åˆ é™¤éœ€è¦å…ˆè°ƒç”¨eq()æŒ‡å®šæ¡ä»¶');

                const queryString = filters.join('&');
                const response = await fetch(`${this.baseUrl}/${table}?${queryString}`, {
                    method: 'DELETE',
                    headers: this.headers
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`åˆ é™¤å¤±è´¥ï¼š${errorText}`);
                }

                return { data: [], error: null };
            }

            // è·å–å•æ¡æ•°æ®ï¼ˆç®€åŒ–å°è£…ï¼‰
            async single() {
                const result = await this.execute();
                return { 
                    data: result.data.length > 0 ? result.data[0] : null,
                    error: result.error
                };
            }
        }

        // ========== ä¸šåŠ¡é€»è¾‘ ==========
        let currentDay = "å‘¨ä¸€";
        let currentMode = "check";
        let supabase;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // åˆå§‹åŒ–ä¿®å¤ç‰ˆSupabaseå®¢æˆ·ç«¯
                supabase = new SimpleSupabase(CONFIG.url, CONFIG.key);
            } catch (e) {
                alert("åˆå§‹åŒ–å¤±è´¥ï¼š" + e.message);
                document.getElementById('loading').classList.remove('active');
                return;
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents();
            // åŠ è½½ä»»åŠ¡
            await loadTasks(currentDay);
        });

        // ç»‘å®šæ‰€æœ‰äº‹ä»¶
        function bindEvents() {
            // åŠŸèƒ½åˆ‡æ¢
            document.getElementById('btn-check').onclick = () => {
                currentMode = "check";
                toggleActive('.func-btn', 'btn-check');
                document.getElementById('taskForm').style.display = 'none';
                loadTasks(currentDay);
            };

            document.getElementById('btn-manage').onclick = () => {
                currentMode = "manage";
                toggleActive('.func-btn', 'btn-manage');
                document.getElementById('taskForm').style.display = 'block';
                loadTasks(currentDay);
            };

            // æ—¥æœŸé€‰æ‹©
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.onclick = () => {
                    currentDay = btn.dataset.day;
                    toggleActive('.day-btn', currentDay);
                    loadTasks(currentDay);
                };
            });

            // è¡¨å•æ“ä½œ
            document.getElementById('btn-save').onclick = saveTask;
            document.getElementById('btn-clear').onclick = () => {
                document.getElementById('taskTime').value = '';
                document.getElementById('taskContent').value = '';
            };
        }

        // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
        function toggleActive(selector, activeVal) {
            document.querySelectorAll(selector).forEach(el => {
                el.classList.remove('active');
                if (el.id === activeVal || el.dataset.day === activeVal) {
                    el.classList.add('active');
                }
            });
        }

        // åŠ è½½ä»»åŠ¡
        async function loadTasks(day) {
            const container = document.getElementById('task-container');
            const loading = document.getElementById('loading');
            loading.classList.add('active');
            container.innerHTML = '';

            try {
                // æ­£ç¡®çš„é“¾å¼è°ƒç”¨ï¼šfrom â†’ eq â†’ order â†’ execute
                const { data: tasks, error } = await supabase
                    .from('tasks')
                    .eq('day', day)
                    .order('time')
                    .execute();

                if (error) throw error;

                if (!tasks || tasks.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:2rem; color:#666;">æš‚æ— ä»»åŠ¡ï¼Œå¯åœ¨ç®¡ç†æ¨¡å¼æ·»åŠ </div>';
                    loading.classList.remove('active');
                    return;
                }

                // åˆ†ç»„æ¸²æŸ“
                const sections = { ä¸Šåˆ: [], ä¸­åˆ: [], ä¸‹åˆ: [], æ™šä¸Š: [] };
                tasks.forEach(task => {
                    const hour = task.time ? parseInt(task.time.split('-')[0].split(':')[0]) : 0;
                    if (hour >=9 && hour <12) sections.ä¸Šåˆ.push(task);
                    else if (hour >=12 && hour <14) sections.ä¸­åˆ.push(task);
                    else if (hour >=14 && hour <18) sections.ä¸‹åˆ.push(task);
                    else sections.æ™šä¸Š.push(task);
                });

                // ç”ŸæˆHTML
                let html = '';
                for (const [title, list] of Object.entries(sections)) {
                    if (list.length === 0) continue;
                    html += `<div class="task-section"><div class="section-title">${title}</div><ul>`;
                    for (const task of list) {
                        // æŸ¥è¯¢æ‰“å¡çŠ¶æ€ï¼ˆé“¾å¼è°ƒç”¨+singleï¼‰
                        const { data: checkin } = await supabase
                            .from('checkins')
                            .eq('task_id', task.id)
                            .eq('user_id', 'default_user')
                            .single();
                        
                        const isCompleted = checkin ? checkin.is_completed : false;
                        const deleteBtn = currentMode === 'manage' ? 
                            `<span style="color:#f44336; cursor:pointer;" onclick="deleteTask('${task.id}')">ğŸ—‘ï¸</span>` : '';
                        
                        html += `<li class="task-item ${isCompleted ? 'completed' : ''}" onclick="toggleCheck('${task.id}', this)">
                            <span class="task-time">${task.time}</span>
                            <span class="task-content">${task.content} ${deleteBtn}</span>
                            <span class="task-check">${isCompleted ? 'âœ“' : ''}</span>
                        </li>`;
                    }
                    html += `</ul></div>`;
                }
                container.innerHTML = html;
                checkAllCompleted(day);
            } catch (e) {
                container.innerHTML = `<div style="text-align:center; padding:2rem; color:#f44336;">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
            } finally {
                loading.classList.remove('active');
            }
        }

        // åˆ‡æ¢æ‰“å¡çŠ¶æ€
        async function toggleCheck(taskId, el) {
            try {
                // æŸ¥è¯¢å½“å‰æ‰“å¡çŠ¶æ€
                const { data: checkin } = await supabase
                    .from('checkins')
                    .eq('task_id', taskId)
                    .eq('user_id', 'default_user')
                    .single();

                const newState = !el.classList.contains('completed');

                if (checkin) {
                    // æ›´æ–°æ‰“å¡çŠ¶æ€ï¼ˆé“¾å¼è°ƒç”¨+updateï¼‰
                    await supabase
                        .from('checkins')
                        .eq('id', checkin.id)
                        .update({ is_completed: newState });
                } else {
                    // æ–°å¢æ‰“å¡è®°å½•
                    await supabase
                        .from('checkins')
                        .insert({ 
                            task_id: taskId, 
                            user_id: 'default_user', 
                            is_completed: newState 
                        });
                }

                // æ›´æ–°UI
                el.classList.toggle('completed', newState);
                el.querySelector('.task-check').textContent = newState ? 'âœ“' : '';
                checkAllCompleted(currentDay);
            } catch (e) {
                alert('æ‰“å¡å¤±è´¥ï¼š' + e.message);
            }
        }

        // ä¿å­˜ä»»åŠ¡
        async function saveTask() {
            const day = document.getElementById('taskDay').value;
            const time = document.getElementById('taskTime').value.trim();
            const content = document.getElementById('taskContent').value.trim();
            
            if (!time || !content) {
                alert('æ—¶é—´æ®µå’Œä»»åŠ¡å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            try {
                // æ’å…¥æ–°ä»»åŠ¡
                await supabase
                    .from('tasks')
                    .insert({ day, time, content });
                
                alert('ä¿å­˜æˆåŠŸï¼');
                document.getElementById('taskTime').value = '';
                document.getElementById('taskContent').value = '';
                loadTasks(currentDay);
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ä»»åŠ¡å—ï¼Ÿ')) return;
            try {
                // å…ˆåˆ é™¤å…³è”çš„æ‰“å¡è®°å½•
                await supabase
                    .from('checkins')
                    .eq('task_id', taskId)
                    .delete();
                
                // å†åˆ é™¤ä»»åŠ¡
                await supabase
                    .from('tasks')
                    .eq('id', taskId)
                    .delete();
                
                loadTasks(currentDay);
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
            }
        }

        // æ£€æŸ¥å…¨éƒ¨å®Œæˆ
        async function checkAllCompleted(day) {
            const { data: tasks } = await supabase
                .from('tasks')
                .eq('day', day)
                .execute();
            
            if (!tasks || tasks.length === 0) return;

            let completed = 0;
            for (const task of tasks) {
                const { data: checkin } = await supabase
                    .from('checkins')
                    .eq('task_id', task.id)
                    .eq('user_id', 'default_user')
                    .single();
                
                if (checkin && checkin.is_completed) completed++;
            }

            if (completed === tasks.length) {
                document.getElementById('celebration').style.display = 'flex';
            }
        }

        // å…³é—­å¼¹çª—
        function closeCelebration() {
            document.getElementById('celebration').style.display = 'none';
        }
    </script>
</body>
</html>
